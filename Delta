const axios = require('axios');
const querystring = require('querystring');

module.exports = async (req, res) => {
    const { link } = req.query;

    if (!link) {
        return res.status(400).json({ warning: "URL needed" });
    }

    let result = "Failed to bypass"; // Default failure message
    const startTime = Date.now(); // Start time for duration tracking

    try {
        // General bypass request
        if (link.startsWith("http")) {
            const encodedLink = querystring.escape(link); // URL encoding
            const response = await axios.get(`http://45.90.12.32:6030/api/bypass?link=${encodedLink}`, { timeout: 10000 });

            if (response.status === 200) {
                if (response.headers['content-type'] === 'application/json') {
                    const bypassData = response.data;
                    result = bypassData.key || "Failed to bypass";
                } else {
                    result = response.data || "Failed to bypass";
                }
            } else {
                result = `Failed to bypass, status code: ${response.status}`;
            }
        } else {
            result = "Invalid URL format";
        }

        const duration = (Date.now() - startTime) / 1000; // Calculate duration in seconds

        res.json({
            result: result,
            duration: duration
        });

    } catch (error) {
        console.error(`An error occurred: ${error.message}`);
        res.status(500).json({ error: "An error occurred during the bypass process" });
    }
};
